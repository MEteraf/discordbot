import discord
from discord import app_commands
from discord.ext import commands
import aiohttp
from aiohttp import web
import asyncio
import os
from dotenv import load_dotenv

load_dotenv()
TOKEN = os.getenv("DISCORD_TOKEN")



# ----------------------
# Intents
# ----------------------
intents = discord.Intents.default()
intents.members = True
intents.message_content = True

# ----------------------
# Ø§ÛŒØ¬Ø§Ø¯ Ø¨Ø§Øª
# ----------------------
bot = commands.Bot(command_prefix="/", intents=intents)


# ----------------------
# ÙˆØ¨â€ŒØ³Ø±ÙˆØ± Ø¨Ø±Ø§ÛŒ Ø±ÙˆØ´Ù† Ù…Ø§Ù†Ø¯Ù†
# ----------------------
async def handle(request):
    return web.Response(text="âœ… Bot is alive and running!")


async def run_webserver():
    app = web.Application()
    app.router.add_get('/', handle)
    runner = web.AppRunner(app)
    await runner.setup()
    port = int(os.environ.get("PORT", 8080))
    site = web.TCPSite(runner, '0.0.0.0', port)
    await site.start()
    print(f"ğŸŒ Web server running on port {port}")


# ----------------------
# Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯Ù† Ø¨Ø§Øª
# ----------------------
@bot.event
async def on_ready():
    print(f"âœ… {bot.user} is online and ready!")
    await bot.change_presence(
        activity=discord.Game(name="Iran Line Role Play | /serverinfo"),
        status=discord.Status.online)

    # Sync Slash Commands
    try:
        guild = discord.Object(id=1277539538977423481)
        bot.tree.copy_global_to(guild=guild)
        await bot.tree.sync(guild=guild)
        print(f"âœ… Slash commands synced to guild {guild.id}!")
    except Exception as e:
        print(f"âŒ Failed to sync commands: {e}")

    # Ø´Ø±ÙˆØ¹ Ù¾ÛŒÙ†Ú¯ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ø² Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯Ù† Ø¨Ø§Øª
    bot.loop.create_task(ping_self())


# ----------------------
# Ù¾ÛŒÙ†Ú¯ Ø®ÙˆØ¯Ú©Ø§Ø± (Ø¨Ø±Ø§ÛŒ Ø¨ÛŒØ¯Ø§Ø± Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ†)
# ----------------------
async def ping_self():
    await asyncio.sleep(10)  # Ú©Ù…ÛŒ ØµØ¨Ø± ØªØ§ ÙˆØ¨â€ŒØ³Ø±ÙˆØ± Ø¨Ø§Ù„Ø§ Ø¨ÛŒØ§Ø¯
    async with aiohttp.ClientSession() as session:
        while True:
            try:
                async with session.get("http://localhost:8080/") as resp:
                    if resp.status == 200:
                        print("ğŸ” Self-ping OK")
            except Exception as e:
                print(f"âš ï¸ Ping failed: {e}")
            await asyncio.sleep(300)  # Ù‡Ø± 5 Ø¯Ù‚ÛŒÙ‚Ù‡


# ----------------------
# Ø¯Ø³ØªÙˆØ± serverinfo
# ----------------------
@bot.tree.command(name="serverinfo", description="Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³Ø±ÙˆØ± Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡")
@app_commands.guild_only()
async def serverinfo(interaction: discord.Interaction):
    guild = interaction.guild
    owner = guild.owner
    created_at = guild.created_at.strftime("%Y-%m-%d")

    embed = discord.Embed(title=f"Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³Ø±ÙˆØ± {guild.name}",
                          description="Server Information",
                          color=discord.Color.blue())

    embed.set_author(name=guild.name,
                     icon_url=guild.icon.url if guild.icon else None)
    embed.add_field(name="ğŸŸ¡ Ù†Ø§Ù… Ø³Ø±ÙˆØ±", value=f"**{guild.name}**", inline=False)
    embed.add_field(name="ğŸŸ¢ Ø¨Ù†ÛŒØ§Ù†Ú¯Ø°Ø§Ø± Ø³Ø±ÙˆØ±",
                    value=owner.mention if owner else "Ù†Ø§Ù…Ø´Ø®Øµ",
                    inline=True)
    embed.add_field(name="ğŸ”µ ØªØ¹Ø¯Ø§Ø¯ Ø§Ø¹Ø¶Ø§",
                    value=str(guild.member_count),
                    inline=True)
    embed.add_field(name="ğŸ“… ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯", value=created_at, inline=True)
    embed.add_field(name="ğŸŸ£ Ø¢ÛŒÙ¾ÛŒ Ø³Ø±ÙˆØ± VMP",
                    value="**5.57.35.181**",
                    inline=False)
    if guild.icon:
        embed.set_thumbnail(url=guild.icon.url)
    embed.set_image(
        url=
        "https://cdn.discordapp.com/attachments/992344550683201607/1427254991374254162/f174038a6a413a80.png"
    )
    embed.set_footer(text="Iran Line Support Team")

    await interaction.response.send_message(embed=embed)


# ----------------------
# Ø¯Ø³ØªÙˆØ± status
# ----------------------
@bot.tree.command(name="status", description="ØªØºÛŒÛŒØ± Ø§Ø³ØªØªÙˆØ³ Ø¨Ø§Øª")
@app_commands.describe(text="Ù…ØªÙ† Ø§Ø³ØªØªÙˆØ³ Ø¬Ø¯ÛŒØ¯")
async def status(interaction: discord.Interaction, text: str = None):
    if text:
        await bot.change_presence(activity=discord.Activity(
            type=discord.ActivityType.watching, name=text),
                                  status=discord.Status.online)
        await interaction.response.send_message(
            f"âœ… Ø§Ø³ØªØªÙˆØ³ Ø¨Ø§Øª Ø¨Ù‡ **{text}** ØªØºÛŒÛŒØ± ÛŒØ§ÙØª!", ephemeral=True)
    else:
        await bot.change_presence(
            activity=discord.Game(name="Iran Line Role Play | /serverinfo"),
            status=discord.Status.online)
        await interaction.response.send_message(
            "âœ… Ø§Ø³ØªØªÙˆØ³ Ø¨Ø§Øª Ø¨Ù‡ Ø­Ø§Ù„Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ ØªØºÛŒÛŒØ± ÛŒØ§ÙØª!", ephemeral=True)


# ----------------------
# Ø§Ø¬Ø±Ø§ÛŒ Ù‡Ù…Ø²Ù…Ø§Ù† ÙˆØ¨â€ŒØ³Ø±ÙˆØ± Ùˆ Ø¨Ø§Øª
# ----------------------
async def main():
    await run_webserver()
    await bot.start(os.getenv("Discord_Token"))


asyncio.run(main())
